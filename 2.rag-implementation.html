

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>RAG - Baseline implementation &#8212; AI Workshop</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '2.rag-implementation';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Experiments" href="3.0.experiments.html" />
    <link rel="prev" title="Context" href="1.context.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="0.intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="AI Workshop - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="AI Workshop - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="0.intro.html">
                    Welcome
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">1. Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1.setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.rag-intro.html">RAG - Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="1.context.html">Context</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">2. Implementation</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">RAG - Baseline implementation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">3. Experimentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="3.0.experiments.html">Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.1.experiment_embedding.html">3.1. Embeddings Experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.2.experiment_chunking.html">3.2. Chunking Experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="3.3.end_to_end_evaluation.html">3.3. End-to-end evaluation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">4. Production</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="4.post-production.html">Post-production</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="5.1.generation-qa.html">Generation of synthetic data</a></li>



</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2F2.rag-implementation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/2.rag-implementation.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>RAG - Baseline implementation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goal">Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-required-libraries-and-environment-variables">Import required libraries and environment variables</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-search-index">1. Create a Search Index</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upload-the-data-to-the-index">2. Upload the Data to the Index</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chunking">2.1 Chunking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#embedding">2.2 Embedding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.3. Upload the data to the Index</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-a-vector-search">3. Perform a vector search</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-a-vector-similarity-search">Perform a vector similarity search</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-prompt">4. Create a prompt</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-function-to-call-the-chat-completion-endpoint">Create a function to call the Chat Completion endpoint</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finally-put-all-the-pieces-together">5. Finally, put all the pieces together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#try-it-out">Try it out</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-what">Now… what?</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="rag-baseline-implementation">
<h1>RAG - Baseline implementation<a class="headerlink" href="#rag-baseline-implementation" title="Permalink to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>In this part, we will build the building blocks of a RAG solution.</p>
<ol class="arabic simple">
<li><p>Creation of a Search Index</p></li>
<li><p>Upload of data</p></li>
<li><p>Perform search</p></li>
<li><p>Creation of a prompt</p></li>
<li><p>Wire everything together</p></li>
</ol>
<!-- To create the index we need the following objects:

- Data Source - a `link` to some data storage
- Azure Index - defines the data structure over which to search
  - Create an empty index based on an index schema
  - Fill in the data using the Search Indexer (below\_)
- Azure Search Indexer - which acts as a crawler that retrieves data from external sources, can also trigger skillsets (Optical Character Recognition) -->
</section>
<section id="goal">
<h2>Goal<a class="headerlink" href="#goal" title="Permalink to this heading">#</a></h2>
<p>The goal of this section is to familiarize yourself with RAG in a hands-on way, so that later on we can experiment with different aspects.</p>
<p>This will also represent a baseline for our RAG application.</p>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h2>
<!-- First, we install the necessary dependencies.
https://github.com/openai/openai-cookbook/blob/main/examples/azure/chat_with_your_own_data.ipynb -->
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span> --no-display
<span class="o">%</span><span class="n">run</span> <span class="o">-</span><span class="n">i</span> <span class="o">./</span><span class="n">pre</span><span class="o">-</span><span class="n">requisites</span><span class="o">.</span><span class="n">ipynb</span>
<span class="o">%</span><span class="n">run</span> <span class="o">-</span><span class="n">i</span> <span class="o">./</span><span class="n">helpers</span><span class="o">/</span><span class="n">search</span><span class="o">.</span><span class="n">ipynb</span>
</pre></div>
</div>
</div>
</div>
<section id="import-required-libraries-and-environment-variables">
<h3>Import required libraries and environment variables<a class="headerlink" href="#import-required-libraries-and-environment-variables" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">azure.core.credentials</span> <span class="kn">import</span> <span class="n">AzureKeyCredential</span>
<span class="kn">from</span> <span class="nn">azure.search.documents</span> <span class="kn">import</span> <span class="n">SearchClient</span>
<span class="kn">from</span> <span class="nn">azure.search.documents.models</span> <span class="kn">import</span> <span class="n">VectorizedQuery</span>
<span class="kn">from</span> <span class="nn">azure.search.documents.indexes.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SearchIndex</span><span class="p">,</span>
    <span class="n">SearchFieldDataType</span><span class="p">,</span>
    <span class="n">SimpleField</span><span class="p">,</span>
    <span class="n">SearchableField</span><span class="p">,</span>
    <span class="n">SearchField</span><span class="p">,</span>
    <span class="n">VectorSearchProfile</span><span class="p">,</span>
    <span class="n">HnswAlgorithmConfiguration</span><span class="p">,</span>
    <span class="n">VectorSearch</span><span class="p">,</span>
    <span class="n">HnswParameters</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">azure.search.documents.indexes</span> <span class="kn">import</span> <span class="n">SearchIndexClient</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">import</span> <span class="nn">openai</span>

<span class="n">openai</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_OPENAI_KEY&quot;</span><span class="p">)</span>
<span class="n">openai</span><span class="o">.</span><span class="n">api_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AZURE_OPENAI_ENDPOINT&quot;</span><span class="p">)</span>
<span class="n">openai</span><span class="o">.</span><span class="n">api_type</span> <span class="o">=</span> <span class="s2">&quot;azure&quot;</span>
<span class="n">openai</span><span class="o">.</span><span class="n">api_version</span> <span class="o">=</span> <span class="s2">&quot;2023-07-01-preview&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="create-a-search-index">
<h2>1. Create a Search Index<a class="headerlink" href="#create-a-search-index" title="Permalink to this heading">#</a></h2>
<!-- https://github.com/Azure/azure-sdk-for-python/blob/main/sdk/search/azure-search-documents/samples/sample_index_crud_operations.py

https://github.com/microsoft/rag-experiment-accelerator/blob/development/rag_experiment_accelerator/init_Index/create_index.py

Used for overall Fields and Semantic Settings inspiration - https://github.com/Azure/azure-search-vector-samples/blob/main/demo-python/code/azure-search-vector-python-huggingface-model-sample.ipynb

Used for SearchField inspiration - https://github.com/Azure/azure-sdk-for-python/blob/main/sdk/search/azure-search-documents/samples/sample_vector_search.py -->
<p>For those familiar with relational databases, you can imagine that:</p>
<ul class="simple">
<li><p>A (search) index ~= A table</p>
<ul>
<li><p>it describes the <a class="reference external" href="https://learn.microsoft.com/en-us/azure/search/search-what-is-an-index#schema-of-a-search-index">schema of your data</a></p></li>
<li><p>it consists of <a class="reference external" href="https://learn.microsoft.com/en-us/azure/search/search-what-is-an-index#field-definitions"><code class="docutils literal notranslate"><span class="pre">field</span> <span class="pre">definitions</span></code></a> described by <a class="reference external" href="https://learn.microsoft.com/en-us/azure/search/search-what-is-an-index#field-attributes"><code class="docutils literal notranslate"><span class="pre">field</span> <span class="pre">attributes</span></code></a> (searchable, filterable, sortable etc)</p></li>
</ul>
</li>
<li><p>A (search) document ~= A row in your table</p></li>
</ul>
<p>In our case, we would like to represent the following:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ChunkId</p></td>
<td><p>SimpleField</p></td>
<td><p>The id of the chunk, in the form of <code class="docutils literal notranslate"><span class="pre">source_document_name+chunk_number</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Source</p></td>
<td><p>SimpleField</p></td>
<td><p>The path to the source document</p></td>
</tr>
<tr class="row-even"><td><p>ChunkContent</p></td>
<td><p>SearchableField</p></td>
<td><p>The content of the chunk</p></td>
</tr>
<tr class="row-odd"><td><p>ChunkContentVector</p></td>
<td><p>SearchField</p></td>
<td><p>The vectorized content of the chunk</p></td>
</tr>
</tbody>
</table>
<p>Run the cell bellow to define a function which creates an index with the above described schema:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span><span class="n">search_index_name</span><span class="p">,</span> <span class="n">service_endpoint</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">SearchIndexClient</span><span class="p">(</span><span class="n">service_endpoint</span><span class="p">,</span> <span class="n">AzureKeyCredential</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="c1"># 1. Define the fields</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">SimpleField</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;chunkId&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">SearchFieldDataType</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
            <span class="n">sortable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">filterable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">SimpleField</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">SearchFieldDataType</span><span class="o">.</span><span class="n">String</span><span class="p">,</span>
            <span class="n">sortable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">filterable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">SearchableField</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;chunkContent&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SearchFieldDataType</span><span class="o">.</span><span class="n">String</span><span class="p">),</span>
        <span class="n">SearchField</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;chunkContentVector&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">SearchFieldDataType</span><span class="o">.</span><span class="n">Collection</span><span class="p">(</span><span class="n">SearchFieldDataType</span><span class="o">.</span><span class="n">Single</span><span class="p">),</span>
            <span class="n">searchable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">vector_search_dimensions</span><span class="o">=</span><span class="mi">1536</span><span class="p">,</span>  <span class="c1"># the dimension of the embedded vector</span>
            <span class="n">vector_search_profile_name</span><span class="o">=</span><span class="s2">&quot;my-vector-config&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># 2. Configure the vector search configuration</span>
    <span class="n">vector_search</span> <span class="o">=</span> <span class="n">VectorSearch</span><span class="p">(</span>
        <span class="n">profiles</span><span class="o">=</span><span class="p">[</span>
            <span class="n">VectorSearchProfile</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;my-vector-config&quot;</span><span class="p">,</span>
                <span class="n">algorithm_configuration_name</span><span class="o">=</span><span class="s2">&quot;my-algorithms-config&quot;</span>
            <span class="p">)</span>
        <span class="p">],</span>
        <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span>
            <span class="c1"># Contains configuration options specific to the hnsw approximate nearest neighbors  algorithm used during indexing and querying</span>
            <span class="n">HnswAlgorithmConfiguration</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;my-algorithms-config&quot;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hnsw&quot;</span><span class="p">,</span>
                <span class="c1"># https://learn.microsoft.com/en-us/python/api/azure-search-documents/azure.search.documents.indexes.models.hnswparameters?view=azure-python-preview#variables</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">HnswParameters</span><span class="p">(</span>
                    <span class="n">m</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="c1"># The size of the dynamic list containing the nearest neighbors, which is used during index time.</span>
                    <span class="c1"># Increasing this parameter may improve index quality, at the expense of increased indexing time.</span>
                    <span class="n">ef_construction</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                    <span class="c1"># The size of the dynamic list containing the nearest neighbors, which is used during search time.</span>
                    <span class="c1"># Increasing this parameter may improve search results, at the expense of slower search.</span>
                    <span class="n">ef_search</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                    <span class="c1"># The similarity metric to use for vector comparisons.</span>
                    <span class="c1"># Known values are: &quot;cosine&quot;, &quot;euclidean&quot;, and &quot;dotProduct&quot;</span>
                    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cosine&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">SearchIndex</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">search_index_name</span><span class="p">,</span>
        <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
        <span class="n">vector_search</span><span class="o">=</span><span class="n">vector_search</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_or_update_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> created or updated&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Run the cell below to create the index. If the index already exists, it will be updated. Make sure to update the <code class="docutils literal notranslate"><span class="pre">seach_index_name</span></code> variable to a unique name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">search_index_name</span> <span class="o">=</span> <span class="s2">&quot;first_index&quot;</span>
<span class="n">create_index</span><span class="p">(</span><span class="n">search_index_name</span><span class="p">,</span> <span class="n">service_endpoint</span><span class="p">,</span> <span class="n">search_index_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index: first_index created or updated
</pre></div>
</div>
</div>
</div>
</section>
<section id="upload-the-data-to-the-index">
<h2>2. Upload the Data to the Index<a class="headerlink" href="#upload-the-data-to-the-index" title="Permalink to this heading">#</a></h2>
<section id="chunking">
<h3>2.1 Chunking<a class="headerlink" href="#chunking" title="Permalink to this heading">#</a></h3>
<p>Data ingestion requires a special attention as it can impact the outcome of the RAG solution. What chunking strategy to use, what AI Enrichment to perform are just few of the considerations. Further discussion and experimentation will be done in <code class="docutils literal notranslate"><span class="pre">Chapter</span> <span class="pre">3.</span> <span class="pre">Experimentation</span> <span class="pre">-</span> <span class="pre">Chunking</span></code>.</p>
<p>In this baseline setup, we have previously chunked the data based on a fixed size (180 tokens) and overlap of 30%.</p>
<p>The chunks can be found <a class="reference download internal" download="" href="_downloads/a386584edd55612607aa4bbb3b7276f1/fixed-size-chunks-engineering-mlops-180-30.json"><span class="xref download myst">here</span></a>. You can take a look at the content of the file.</p>
</section>
<section id="embedding">
<h3>2.2 Embedding<a class="headerlink" href="#embedding" title="Permalink to this heading">#</a></h3>
<p>Embedding the chunks in vectors can also be done in various ways. Further discussion and experimentation will be done in <code class="docutils literal notranslate"><span class="pre">Chapter</span> <span class="pre">3.</span> <span class="pre">Experimentation</span> <span class="pre">-</span> <span class="pre">Embeeding</span></code>.</p>
<p>In this baseline setup, we will take a vanilla approach, where:</p>
<ul class="simple">
<li><p>We used the embedding model from OpenAI, <a class="reference external" href="https://platform.openai.com/docs/guides/embeddings/what-are-embeddings"><code class="docutils literal notranslate"><span class="pre">text-embedding-ada-002</span></code></a> since this is one obvious choice to start with</p></li>
</ul>
<p>The outcome can be found <a class="reference download internal" download="" href="_downloads/dc26d92e62578d05c85e165ebe25c1b7/fixed-size-chunks-180-30-batch-engineering-mlops-ada.json"><span class="xref download myst">here</span></a>. You can take a look at the content of the file.</p>
<p>Let’s define the path to the embedded chunks: TODO</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">180</span>
<span class="n">chunk_overlap</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">path_to_embedded_chunks</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./output/pre-generated/embeddings/fixed-size-chunks-</span><span class="si">{</span>
<span class="w">    </span><span class="n">chunk_size</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">chunk_overlap</span><span class="si">}</span><span class="s2">-batch-engineering-mlops-ada.json&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>2.3. Upload the data to the Index<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<!-- https://github.com/microsoft/rag-experiment-accelerator/blob/development/rag_experiment_accelerator/ingest_data/acs_ingest.py -->
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">upload_data</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">search_index_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">documents</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="n">search_client</span> <span class="o">=</span> <span class="n">SearchClient</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="o">=</span><span class="n">service_endpoint</span><span class="p">,</span>
            <span class="n">index_name</span><span class="o">=</span><span class="n">search_index_name</span><span class="p">,</span>
            <span class="n">credential</span><span class="o">=</span><span class="n">credential</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">search_client</span><span class="o">.</span><span class="n">upload_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Uploaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="si">}</span><span class="s2"> documents to Index: </span><span class="si">{</span><span class="n">search_index_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error uploading documents: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">upload_data</span><span class="p">(</span><span class="n">path_to_embedded_chunks</span><span class="p">,</span> <span class="n">search_index_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Uploaded 3236 documents to Index: first_index
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="perform-a-vector-search">
<h2>3. Perform a vector search<a class="headerlink" href="#perform-a-vector-search" title="Permalink to this heading">#</a></h2>
<!-- https://techcommunity.microsoft.com/t5/ai-azure-ai-services-blog/azure-ai-search-outperforming-vector-search-with-hybrid/ba-p/3929167 -->
<!-- There are two layers of execution: retrieval and ranking.

- Retrieval - also called L1, has the goal to quickly find all the documents from the index that satisfy the search criteria (possibly across millions or billions of documents). These are scored to pick the top few (typically in order of 50) to return to the user or to feed the next layer. Azure AI Search supports three different models:

  - Keyword: Uses traditional full-text search methods – content is broken into terms through language-specific text analysis, inverted indexes are created for fast retrieval, and the BM25 probabilistic model is used for scoring.

  - Vector: Documents are converted from text to vector representations using an embedding model. Retrieval is performed by generating a query embedding and finding the documents whose vectors are closest to the query’s. We used Azure Open AI text-embedding-ada-002 (Ada-002) embeddings and cosine similarity for all our tests in this post.
  - Hybrid: Performs both keyword and vector retrieval and applies a fusion step to select the best results from each technique. Azure AI Search currently uses Reciprocal Rank Fusion (RRF) to produce a single result set.

- Ranking – also called L2, takes a subset of the top L1 results and computes higher quality relevance scores to reorder the result set. The L2 can improve the L1's ranking because it applies more computational power to each result. The L2 ranker can only reorder what the L1 already found – if the L1 missed an ideal document, the L2 can't fix that. L2 ranking is critical for RAG applications to make sure the best results are in the top positions.
  - Semantic ranking is performed by Azure AI Search's L2 ranker which utilizes multi-lingual, deep learning models adapted from Microsoft Bing. The Semantic ranker can rank the top 50 results from the L1.

https://techcommunity.microsoft.com/t5/ai-azure-ai-services-blog/azure-ai-search-outperforming-vector-search-with-hybrid/ba-p/3929167 -->
<p>There are <a class="reference external" href="https://learn.microsoft.com/en-us/azure/ai-services/openai/concepts/use-your-data?tabs=ai-search#search-options">various types of search</a> that one can perform such as: keyword search, semantic search, vector search, hybrid search. Since we generated embeddings for our chunks and we would like to leverage the power of vector search, in this baseline solution we will perform a simple vector search. Further discussion and experimentation will be done in <code class="docutils literal notranslate"><span class="pre">Chapter</span> <span class="pre">3.</span> <span class="pre">Experimentation</span> <span class="pre">-</span> <span class="pre">Search</span></code></p>
<section id="perform-a-vector-similarity-search">
<h3>Perform a vector similarity search<a class="headerlink" href="#perform-a-vector-similarity-search" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">search_documents</span><span class="p">(</span><span class="n">query_embeddings</span><span class="p">):</span>
    <span class="n">search_client</span> <span class="o">=</span> <span class="n">SearchClient</span><span class="p">(</span>
        <span class="n">service_endpoint</span><span class="p">,</span> <span class="n">search_index_name</span><span class="p">,</span>
        <span class="n">credential</span><span class="o">=</span><span class="n">credential</span>
    <span class="p">)</span>

    <span class="n">vector_query</span> <span class="o">=</span> <span class="n">VectorizedQuery</span><span class="p">(</span>
        <span class="n">vector</span><span class="o">=</span><span class="n">query_embeddings</span><span class="p">,</span> <span class="n">k_nearest_neighbors</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s2">&quot;chunkContentVector&quot;</span>
    <span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">search_client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="n">search_text</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vector_queries</span><span class="o">=</span><span class="p">[</span><span class="n">vector_query</span><span class="p">],</span>
        <span class="n">select</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;chunkContent&quot;</span><span class="p">,</span> <span class="s2">&quot;chunkId&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">documents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;chunkContent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;chunkContent&quot;</span><span class="p">]</span>
        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>
        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;chunkId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="s2">&quot;chunkId&quot;</span><span class="p">]</span>
        <span class="n">documents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">documents</span>
</pre></div>
</div>
</div>
</div>
<p>Run the search_documents function to find the most similar documents to a given query.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What does the develop phase include&quot;</span>
<span class="n">embedded_query</span> <span class="o">=</span> <span class="n">oai_query_embedding</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">search_documents</span><span class="p">(</span><span class="n">embedded_query</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;chunkContent&#39;: &#39;Steps\n\nDesign Phase: Both developers design the interface together. This includes:\n\nMethod signatures and names\nWriting documentation or docstrings for what the methods are intended to do.\nArchitecture decisions that would influence testing (Factory patterns, etc.)\n\nImplementation Phase: The developers separate and parallelize work, while continuing to communicate.\n\nDeveloper A will design the implementation of the methods, adhering to the previously decided design.\nDeveloper B will concurrently write tests for the same method signatures, without knowing details of the implementation.\n\nIntegration &amp; Testing Phase: Both developers commit their code and run the tests.&#39;,
  &#39;source&#39;: &#39;..\\data\\docs\\code-with-engineering\\agile-development\\advanced-topics\\collaboration\\virtual-collaboration.md&#39;,
  &#39;chunkId&#39;: &#39;chunk16_3&#39;},
 {&#39;chunkContent&#39;: &#39;In order to minimize the risk and set the expectations on the right way for all parties, an identification phase is important to understand each other.\nSome potential steps in this phase may be as following (not limited):\n\nWorking agreement\n\nIdentification of styles/preferences in communication, sharing, learning, decision making of each team member\n\nTalking about necessity of pair programming\n\nDecisions on backlog management &amp; refinement meetings, weekly design sessions, social time sessions...etc.\n\nSync/Async communication methods, work hours/flexible times\n\nDecisions and identifications of charts that will be helpful to provide transparent and true information to everyone\n\nIdentification of &quot;Software Craftspersonship&quot; areas which means the tools and methods will be widely used during the engagement and taking the required actions on team upskilling side if necessary.&#39;,
  &#39;source&#39;: &#39;..\\data\\docs\\code-with-engineering\\agile-development\\advanced-topics\\collaboration\\teaming-up.md&#39;,
  &#39;chunkId&#39;: &#39;chunk15_1&#39;},
 {&#39;chunkContent&#39;: &#39;Integration &amp; Testing Phase: Both developers commit their code and run the tests.\n\nUtopian Scenario: All tests run and pass correctly.\nRealistic Scenario: The tests have either broken or failed due to flaws in testing. This leads to further clarification of the design and a discussion of why the tests failed.\n\nThe developers will repeat the three phases until the code is functional and tested.\n\nWhen to follow the RTT strategy\n\nRTT works well under specific circumstances. If collaboration needs to happen virtually, and all communication is virtual, RTT reduces the need for constant communication while maintaining the benefits of a joint design session. This considers the human element: Virtual communication is more exhausting than in person communication.&#39;,
  &#39;source&#39;: &#39;..\\data\\docs\\code-with-engineering\\agile-development\\advanced-topics\\collaboration\\virtual-collaboration.md&#39;,
  &#39;chunkId&#39;: &#39;chunk16_4&#39;}]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="create-a-prompt">
<h2>4. Create a prompt<a class="headerlink" href="#create-a-prompt" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_prompt</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">documents</span><span class="p">):</span>
    <span class="n">system_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    Instructions:</span>

<span class="s2">    &quot;You are an AI assistant that helps users answer questions given a specific context.</span>
<span class="s2">    You will be given a context (Retrieved Documents) and asked a question (User Question) based on that context.</span>
<span class="s2">    Your answer should be as precise as possible and should only come from the context.</span>
<span class="s2">    Please add citation after each sentence when possible in a form &quot;(Source: source+chunkId),</span>
<span class="s2">    where both &#39;source&#39; and &#39;chunkId&#39; are taken from the Retrieved Documents.&quot;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">user_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ## Retrieve Documents:</span>
<span class="s2">    </span><span class="si">{</span><span class="n">documents</span><span class="si">}</span>

<span class="s2">    ## User Question</span>
<span class="s2">    </span><span class="si">{</span><span class="n">query</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">final_message</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_prompt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">END OF CONTEXT&quot;</span><span class="p">},</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">final_message</span>
</pre></div>
</div>
</div>
</div>
<section id="create-a-function-to-call-the-chat-completion-endpoint">
<h3>Create a function to call the Chat Completion endpoint<a class="headerlink" href="#create-a-function-to-call-the-chat-completion-endpoint" title="Permalink to this heading">#</a></h3>
<p>For this, we will use <a class="reference external" href="https://github.com/openai/openai-python">OpenAI library for Python</a>:</p>
<!-- https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/migration?tabs=python-new%2Cdalle-fix#chat-completions
https://learn.microsoft.com/en-us/azure/ai-services/openai/reference?WT.mc_id=AZ-MVP-5004796#completions -->
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">AzureOpenAI</span>


<span class="k">def</span> <span class="nf">call_llm</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">AzureOpenAI</span><span class="p">(</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">azure_openai_key</span><span class="p">,</span>
        <span class="n">api_version</span><span class="o">=</span><span class="n">azure_openai_api_version</span><span class="p">,</span>
        <span class="n">azure_endpoint</span><span class="o">=</span><span class="n">azure_aoai_endpoint</span>
    <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">azure_openai_chat_deployment</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="finally-put-all-the-pieces-together">
<h2>5. Finally, put all the pieces together<a class="headerlink" href="#finally-put-all-the-pieces-together" title="Permalink to this heading">#</a></h2>
<p>Note: Usually in a RAG solution there is an intent extraction step.
However, since we are having a QA system and not a chat, in our workshop we are assuming that the intent is the actual query.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">custom_rag_solution</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 1. Embed the query using the same embedding model as your data in the Index</span>
        <span class="n">query_embeddings</span> <span class="o">=</span> <span class="n">oai_query_embedding</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Intent recognition - skipped in our workhsop</span>

        <span class="c1"># 1. Search for relevant documents</span>
        <span class="n">search_response</span> <span class="o">=</span> <span class="n">search_documents</span><span class="p">(</span><span class="n">query_embeddings</span><span class="p">)</span>

        <span class="c1"># 2. Create prompt with the query, retrieved documents and conversation (kept to &quot;&quot;)</span>
        <span class="n">prompt_from_chunk_context</span> <span class="o">=</span> <span class="n">create_prompt</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">search_response</span><span class="p">)</span>

        <span class="c1"># 3. Call the Azure OpenAI GPT model</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">call_llm</span><span class="p">(</span><span class="n">prompt_from_chunk_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="try-it-out">
<h2>Try it out<a class="headerlink" href="#try-it-out" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What does the develop phase include?&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User question: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">custom_rag_solution</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>User question: What does the develop phase include?
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response: The develop phase includes designing the interface together, such as method signatures and names, writing documentation or docstrings for what the methods are intended to do and making architecture decisions that would influence testing, such as Factory patterns, etc. (Source: ..\data\docs\code-with-engineering\agile-development\advanced-topics\collaboration\virtual-collaboration.md, chunk16_3)
</pre></div>
</div>
</div>
</div>
<p>Perfect! <strong>This answer</strong> seems to make sense.</p>
</section>
<section id="now-what">
<h2>Now… what?<a class="headerlink" href="#now-what" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Is this <em>good enough</em>?</p></li>
<li><p>What does <em>good enough</em> even mean?</p></li>
<li><p>How can I prove that this works <em>as expected</em>?</p></li>
<li><p>What does <em>works as expected</em> even mean?!</p></li>
</ul>
<p>Let’s go to <code class="docutils literal notranslate"><span class="pre">Chapter</span> <span class="pre">3.</span> <span class="pre">Experimentation</span></code>, to try to tackle these questions.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="1.context.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Context</p>
      </div>
    </a>
    <a class="right-next"
       href="3.0.experiments.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Experiments</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goal">Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-required-libraries-and-environment-variables">Import required libraries and environment variables</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-search-index">1. Create a Search Index</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upload-the-data-to-the-index">2. Upload the Data to the Index</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chunking">2.1 Chunking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#embedding">2.2 Embedding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.3. Upload the data to the Index</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-a-vector-search">3. Perform a vector search</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-a-vector-similarity-search">Perform a vector similarity search</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-prompt">4. Create a prompt</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-function-to-call-the-chat-completion-endpoint">Create a function to call the Chat Completion endpoint</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finally-put-all-the-pieces-together">5. Finally, put all the pieces together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#try-it-out">Try it out</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#now-what">Now… what?</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Raouf Aliouat & Adina Stoll
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>